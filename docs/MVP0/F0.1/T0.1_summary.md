# MVP-0 F0.1 T0.1: Hermetic Sandbox Implementation Summary

## What Changed

### Files Created
- `env/hermetic.py` - Core hermetic execution module with HermeticRun context manager
- `env/__init__.py` - Package initialization  
- `env/_network_guard.py` - Network blocking utilities
- `tests/test_hermetic.py` - Unit tests (4 tests)
- `tests/integration/test_hermetic_integration.py` - Integration tests (3 tests)
- `configs/generation.yaml` - Configuration parity source
- `pyproject.toml` - Project configuration and dependencies

### Key Classes and Functions
- `HermeticRun` - Context manager for hermetic execution
- `HermeticNetworkError` - Exception for network access attempts
- Network guard via `sitecustomize.py` injection into venv
- CLI interface via `python -m env.hermetic selftest`

## Why

The hermetic sandbox ensures deterministic, isolated test execution by:
1. Creating fresh git worktrees detached to specific SHAs
2. Isolating Python environments via fresh venvs  
3. Blocking outbound network access during tests
4. Ensuring complete cleanup with no residual artifacts
5. Providing deterministic run manifests for reproducibility

This foundation is critical for reliable benchmarking and evaluation across the HERMES system.

## How It Works

### Architecture
1. **Worktree Isolation**: Uses `git worktree add --detach` to create isolated code copies
2. **Venv Creation**: Fresh Python venv per run in `scratch/<task_id>/<run_id>/venv`
3. **Network Guard**: Injects `sitecustomize.py` into venv that replaces `socket.socket` and `socket.create_connection` 
4. **Manifest Generation**: Captures seeds, SHAs, config hashes, OS fingerprint
5. **Stable Hash**: Deterministic hash from task_id, seed, repo_sha, config_hash, OS fingerprint
6. **Cleanup**: Idempotent removal of worktrees, scratch dirs, and `/tmp/hermes_*` files

### Timing
- Uses `time.perf_counter_ns()` for monotonic timing
- Tracks setup and cleanup durations in milliseconds

## Tests Run

### Unit Tests (4 passed)
```
✓ test_network_blocked_in_venv_py - Network access blocked in hermetic venv
✓ test_worktree_detached_and_clean - Worktree at correct SHA and clean
✓ test_manifest_fields_and_stable_hash - Manifest complete, stable hash deterministic  
✓ test_cleanup_no_residue - All artifacts removed after context exit
```

### Integration Tests (3 passed)
```
✓ test_hermetic_selftest_determinism - Same seed produces identical stable_hash
✓ test_hermetic_metrics_generation - Metrics file created with proper keys
✓ test_hermetic_cleanup_verification - No residual artifacts after run
```

### Test Results
- All 7 tests passed
- Total test time: ~30 seconds
- Network guard confirmed blocking connections
- Determinism verified: seed 123 → stable_hash `0039dd2d28a4c077`

## Metrics Impact

### Collected Metrics (from metrics.json)
```json
{
  "sandbox_setup_ms_p50": 3029.92,
  "sandbox_cleanup_ms_p95": 129.29,
  "network_guard_install_ms": 5,
  
  "bytes_per_solve": null,
  "tokens_prefill": null,
  "tokens_decode": null,
  "e2e_latency_ms_p50": null,
  "e2e_latency_ms_p95": null,
  "message_path_ms_p95": null,
  "mcp_deref_ms_p95": null,
  "sae_accept_rate": null,
  "rollback_ms_p95": null,
  "pass_at_1": null
}
```

### Performance
- Setup time: ~3.0 seconds (includes worktree + venv creation)
- Cleanup time: ~129ms (fast removal)
- Network guard overhead: ~5ms (negligible)

## Deviations from Spec

None. Implementation fully conforms to MVP-0 F0.1 T0.1 requirements:
- ✅ Fresh worktree + venv created
- ✅ Network guard ON (HERMES_HERMETIC=1)
- ✅ Run manifest emitted with all required fields
- ✅ Re-run determinism verified (same seed → identical stable_hash)
- ✅ No residue after cleanup (empty scratch, no /tmp/hermes_*)
- ✅ Monotonic timing via perf_counter_ns()
- ✅ Scratch layout follows `scratch/<task_id>/<run_id>/` pattern
- ✅ Config parity via configs/generation.yaml hash

## Next Steps

1. **MVP-0 F0.3 T0.3**: Implement `eval/run_arms.py` to enforce single config parity and deterministic seeding across arms
2. **MVP-1 Anchors**: Build MCP anchor system for large artifact storage
3. **Integration**: Wire hermetic sandbox into agent execution pipeline
4. **Optimization**: Consider parallel worktree/venv creation for multi-task runs
5. **Monitoring**: Add telemetry for sandbox creation/cleanup failures

## Evidence Pack

### Determinism Verification
```bash
# Two runs with seed 123 produce identical stable_hash
Run 1: Stable hash: 0039dd2d28a4c077
Run 2: Stable hash: 0039dd2d28a4c077
STABLE_HASH_MATCH= True
```

### Cleanup Verification
```bash
$ find scratch/MVP-0-F0.1-T0.1 -type f
# No output - directory is empty

$ ls /tmp/hermes_*
# No files found
```

### Network Guard Verification
```
Network guard active: connections blocked
socket.create_connection(("1.1.1.1", 80)) → HermeticNetworkError
```

### Git Worktree Status
```
Worktree SHA: 65db827ca942b1417cf0a8539266802807a8d5f7
git status --porcelain → empty (clean worktree)
```

### Config Hash Verification
```
Config SHA256: 19d2bcc56010777f7b6bcb333c5d18eb3e82ec673454ac9d411b6b37e1c4c35a
Manifest hash: 19d2bcc56010777f (first 16 chars match)
```

## Acceptance Criteria Met

✅ **MVP-0 F0.1 T0.1**: Fresh worktree + venv; network guard ON; run manifest emitted; re-run determinism (same seed → identical stable hash); no residue after cleanup.

✅ **Timing**: Monotonic clock via `time.perf_counter_ns()`

✅ **Scratch layout**: `scratch/<task_id>/<run_id>/...` as specified

✅ **Config parity**: Hash of `configs/generation.yaml` computed and included

✅ **Evidence**: Test outputs, metrics, manifests, and cleanup verification provided