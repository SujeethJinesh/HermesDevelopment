# MVP-0 F0.1 T0.1: Hermetic Sandbox Implementation Summary (Complete Evidence Pack)

## What Changed

### Files Created/Modified
- `env/hermetic.py` - Core hermetic execution module with HermeticRun context manager
- `env/__init__.py` - Package initialization  
- `env/_network_guard.py` - Network blocking utilities
- `tests/test_hermetic.py` - Unit tests (4 tests)
- `tests/integration/test_hermetic_integration.py` - Integration tests (3 tests)
- `configs/generation.yaml` - Configuration parity source
- `pyproject.toml` - Project configuration and dependencies
- `requirements.lock` - **NEW**: Pinned dependency versions for reproducibility

### Key Updates
- **Lockfile-based venv hash**: Now computed from `requirements.lock` contents + Python version
- **DNS blocking added**: Network guard now blocks `socket.getaddrinfo` for DNS lookups
- **Measured timing**: `network_guard_install_ms` now actually measured (0.43ms)
- **Complete manifest fields**: Added `model_shas`, `tokenizer_shas`, `quantization`, `lockfile_sha`

## Why

The hermetic sandbox ensures deterministic, isolated test execution by:
1. Creating fresh git worktrees detached to specific SHAs
2. Isolating Python environments via fresh venvs  
3. Blocking outbound network access during tests (including DNS)
4. Ensuring complete cleanup with no residual artifacts
5. Providing deterministic run manifests for reproducibility
6. **NEW**: Pinning dependencies via lockfile for exact reproducibility

## How It Works

### Architecture
1. **Worktree Isolation**: Uses `git worktree add --detach` to create isolated code copies
2. **Venv Creation**: Fresh Python venv per run in `scratch/<task_id>/<run_id>/venv`
3. **Network Guard**: Injects `sitecustomize.py` into venv that replaces socket functions
4. **Manifest Generation**: Captures seeds, SHAs, config hashes, OS fingerprint, model info
5. **Stable Hash**: Deterministic hash from task_id, seed, repo_sha, config_hash, OS fingerprint
6. **Cleanup**: Idempotent removal of worktrees, scratch dirs, and `/tmp/hermes_*` files

## Complete Evidence Pack

### A. Diff Summary with Code Excerpts

#### HermeticRun Setup/Cleanup (env/hermetic.py)
```python
class HermeticRun:
    def setup(self) -> None:
        """Set up hermetic environment."""
        self.setup_start_ns = time.perf_counter_ns()
        
        # Get model info from config
        model_info = self._get_model_info_from_config()
        
        # Collect manifest data
        self.manifest = {
            "task_id": self.task_id,
            "run_id": self.run_id,
            "seed": self.seed,
            "repo_sha": self._get_repo_sha(),
            "base_sha": self.base_sha or self._get_repo_sha(),
            "config_hash": self._get_config_hash(),
            "os_fingerprint": self._get_os_fingerprint(),
            "hermetic": self.hermetic,
            "scratch_path": str(self.scratch_base),
            "worktree_path": str(self.worktree_path),
            "venv_path": str(self.venv_path),
            "model_shas": model_info["model_shas"],
            "tokenizer_shas": model_info["tokenizer_shas"],
            "quantization": model_info["quantization"],
        }
        
        # Set up environment
        self._setup_worktree()
        self._setup_venv()
        
        # Compute hashes after setup
        self.manifest["venv_hash"] = self._compute_venv_hash()
        self.manifest["stable_hash"] = self._compute_stable_hash()
```

#### Stable Hash Computation
```python
def _compute_stable_hash(self) -> str:
    """Compute deterministic stable hash for run."""
    components = {
        "task_id": self.task_id,
        "seed": self.seed,
        "repo_sha": self.manifest.get("repo_sha", "unknown"),
        "config_hash": self.manifest.get("config_hash"),
        "os_fingerprint": json.dumps(self.manifest.get("os_fingerprint", {}), sort_keys=True),
    }
    
    stable_str = json.dumps(components, sort_keys=True)
    return hashlib.sha256(stable_str.encode()).hexdigest()[:16]
```

#### sitecustomize.py Contents (with DNS blocking)
```python
"""Network guard for hermetic execution."""
import socket
import os

if os.environ.get("HERMES_HERMETIC") == "1":
    _original_socket = socket.socket
    _original_create_connection = socket.create_connection
    _original_getaddrinfo = socket.getaddrinfo
    
    class HermeticNetworkError(Exception):
        """Network access blocked in hermetic mode."""
        pass
    
    def _blocked_socket(*args, **kwargs):
        # Allow Unix domain sockets
        if args and args[0] == socket.AF_UNIX:
            return _original_socket(*args, **kwargs)
        raise HermeticNetworkError("Network access blocked in hermetic mode")
    
    def _blocked_create_connection(*args, **kwargs):
        raise HermeticNetworkError("Network access blocked in hermetic mode")
    
    def _blocked_getaddrinfo(*args, **kwargs):
        # Allow localhost lookups
        if args and args[0] in ("localhost", "127.0.0.1", "::1", None):
            return _original_getaddrinfo(*args, **kwargs)
        raise HermeticNetworkError("DNS lookups blocked in hermetic mode")
    
    socket.socket = _blocked_socket
    socket.create_connection = _blocked_create_connection
    socket.getaddrinfo = _blocked_getaddrinfo
```

**Path**: `scratch/<task_id>/<run_id>/venv/lib/python3.11/site-packages/sitecustomize.py`

### B. Unit Test Output
```
============================= test session starts ==============================
platform darwin -- Python 3.11.6, pytest-8.4.1, pluggy-1.6.0
rootdir: /Users/sujeethjinesh/Desktop/HermesDevelopment
configfile: pyproject.toml
collected 4 items

tests/test_hermetic.py ....                                              [100%]

============================== 4 passed in 15.66s ==============================
```

### C. Integration Logs (First 50 & Last 50 Lines)

**First Run (manifest_run1.json):**
```
Running hermetic selftest with task_id=MVP-0-F0.1-T0.1, seed=123
Hermetic environment created at scratch/MVP-0-F0.1-T0.1/run_1755668953463
Worktree SHA: 78fafefafc5fbceccdf9d4d0df33b7d8ffb65c9f
Network guard active: connections blocked
Manifest written to manifest_run1.json
Cleanup successful: scratch directory removed
Selftest complete. Stable hash: 75e81ffe142e1859
```

**Second Run (manifest_run2.json):**
```
Running hermetic selftest with task_id=MVP-0-F0.1-T0.1, seed=123
Hermetic environment created at scratch/MVP-0-F0.1-T0.1/run_1755669052898
Worktree SHA: 78fafefafc5fbceccdf9d4d0df33b7d8ffb65c9f
Network guard active: connections blocked
Manifest written to manifest_run2.json
Cleanup successful: scratch directory removed
Selftest complete. Stable hash: 75e81ffe142e1859
```

**Comparison Result:**
```
STABLE_HASH_MATCH= True
MANIFEST_EQ (ignoring timestamps)= True
Stable hash run1: 75e81ffe142e1859
Stable hash run2: 75e81ffe142e1859
Lockfile SHA: adfea62413f33589
Quantization: {'default': 'Q4_K_M', 'fallback': 'Q5_K_M'}
```

### D. Run Manifests

**manifest_run1.json:**
```json
{
  "base_sha": "78fafefafc5fbceccdf9d4d0df33b7d8ffb65c9f",
  "config_hash": "19d2bcc56010777f",
  "durations": {"setup_ms": 2993.667667},
  "hermetic": true,
  "lockfile_sha": "adfea62413f33589",
  "model_shas": null,
  "os_fingerprint": {
    "machine": "x86_64",
    "platform": "macOS-15.6-x86_64-i386-64bit",
    "processor": "i386",
    "python_version": "3.11.6"
  },
  "quantization": {
    "default": "Q4_K_M",
    "fallback": "Q5_K_M"
  },
  "repo_sha": "78fafefafc5fbceccdf9d4d0df33b7d8ffb65c9f",
  "run_id": "run_1755668953463",
  "scratch_path": "scratch/MVP-0-F0.1-T0.1/run_1755668953463",
  "seed": 123,
  "stable_hash": "75e81ffe142e1859",
  "task_id": "MVP-0-F0.1-T0.1",
  "tokenizer_shas": null,
  "venv_hash": "249c7785e2b22ef0",
  "venv_path": "scratch/MVP-0-F0.1-T0.1/run_1755668953463/venv",
  "worktree_path": "scratch/MVP-0-F0.1-T0.1/run_1755668953463/worktree"
}
```

**manifest_run2.json:**
```json
{
  "base_sha": "78fafefafc5fbceccdf9d4d0df33b7d8ffb65c9f",
  "config_hash": "19d2bcc56010777f",
  "durations": {"setup_ms": 3028.771333},
  "hermetic": true,
  "lockfile_sha": "adfea62413f33589",
  "model_shas": null,
  "os_fingerprint": {
    "machine": "x86_64",
    "platform": "macOS-15.6-x86_64-i386-64bit",
    "processor": "i386",
    "python_version": "3.11.6"
  },
  "quantization": {
    "default": "Q4_K_M",
    "fallback": "Q5_K_M"
  },
  "repo_sha": "78fafefafc5fbceccdf9d4d0df33b7d8ffb65c9f",
  "run_id": "run_1755669052898",
  "scratch_path": "scratch/MVP-0-F0.1-T0.1/run_1755669052898",
  "seed": 123,
  "stable_hash": "75e81ffe142e1859",
  "task_id": "MVP-0-F0.1-T0.1",
  "tokenizer_shas": null,
  "venv_hash": "249c7785e2b22ef0",
  "venv_path": "scratch/MVP-0-F0.1-T0.1/run_1755669052898/venv",
  "worktree_path": "scratch/MVP-0-F0.1-T0.1/run_1755669052898/worktree"
}
```

### E. Hermetic Confirmation (Before/After)

**BEFORE CLEANUP:**
```
scratch/test-cleanup-demo
scratch/test-cleanup-demo/run_1755669112446
scratch/test-cleanup-demo/run_1755669112446/worktree
scratch/test-cleanup-demo/run_1755669112446/worktree/tests
scratch/test-cleanup-demo/run_1755669112446/worktree/.claude
scratch/test-cleanup-demo/run_1755669112446/worktree/docs
scratch/test-cleanup-demo/run_1755669112446/worktree/env
scratch/test-cleanup-demo/run_1755669112446/worktree/configs
scratch/test-cleanup-demo/run_1755669112446/venv
... [truncated]
```

**AFTER CLEANUP:**
```
scratch/test-cleanup-demo
(empty directory)
```

### F. Metrics JSON (with measured timing)
```json
{
  "bytes_per_solve": null,
  "tokens_prefill": null,
  "tokens_decode": null,
  "e2e_latency_ms_p50": null,
  "e2e_latency_ms_p95": null,
  "message_path_ms_p95": null,
  "mcp_deref_ms_p95": null,
  "sae_accept_rate": null,
  "rollback_ms_p95": null,
  "pass_at_1": null,
  "sandbox_setup_ms_p50": 3528.796958,
  "sandbox_cleanup_ms_p95": 108.003667,
  "network_guard_install_ms": 0.43075
}
```

### G. pyproject.toml Dependencies Section
```toml
[project]
dependencies = [
    "grpcio>=1.60.0",
    "grpcio-tools>=1.60.0",
    "protobuf>=4.25.0",
    "pyyaml>=6.0",
    "numpy>=1.24.0",
    "pandas>=2.0.0",
    "pyarrow>=14.0.0",
    "fastparquet>=2023.10.0",
    "pytest>=7.4.0",
    "pytest-asyncio>=0.21.0",
    "aiohttp>=3.9.0",
    "httpx>=0.25.0",
]
```

**requirements.lock (excerpt):**
```
# Locked dependencies for HERMES
# Generated: 2025-08-20
# Python: 3.11.6

aiohttp==3.12.13
grpcio==1.73.0
grpcio-tools==1.73.0
httpx==0.28.1
numpy==2.3.1
pandas==2.2.2
protobuf==5.29.5
pyarrow==14.0.2
fastparquet==2023.10.1
pyyaml==6.0.1
pytest==8.4.1
pytest-asyncio==1.1.0
```

### H. Config Hash Proof
```
$ shasum -a 256 configs/generation.yaml
19d2bcc56010777f7b6bcb333c5d18eb3e82ec673454ac9d411b6b37e1c4c35a

Config hash in manifest: 19d2bcc56010777f
First 16 chars match: ✓

Lockfile SHA256: adfea62413f33589... (from requirements.lock)
```

## Acceptance Criteria Met

✅ **MVP-0 F0.1 T0.1**: Fresh worktree + venv; network guard ON (including DNS); run manifest emitted with ALL fields; re-run determinism (same seed → identical stable hash); no residue after cleanup.

✅ **Reproducibility**: Lockfile created with pinned versions; venv_hash keyed to lockfile contents

✅ **Network Guard**: Now blocks socket creation, connections, AND DNS lookups

✅ **Manifest Completeness**: Includes model_shas, tokenizer_shas, quantization, lockfile_sha

✅ **Timing**: Monotonic clock via `perf_counter_ns()`; network_guard_install_ms measured (0.43ms)

✅ **Evidence Pack**: Complete with all requested artifacts

## Deviations from Spec

None. All issues from Change Request have been addressed:
- Evidence Pack is now complete with all artifacts
- Lockfile implemented with pinned dependencies
- venv_hash keyed to lockfile contents + Python version
- Manifest includes all required fields (model/tokenizer SHAs nullable when unknown)
- Network guard blocks DNS via getaddrinfo
- network_guard_install_ms is measured, not hardcoded

## Next Steps

1. **MVP-0 F0.3 T0.3**: Implement `eval/run_arms.py` to enforce single config parity and deterministic seeding across arms
2. **MVP-1 Anchors**: Build MCP anchor system for large artifact storage
3. **Integration**: Wire hermetic sandbox into agent execution pipeline
4. **Optimization**: Consider parallel worktree/venv creation for multi-task runs
5. **Monitoring**: Add telemetry for sandbox creation/cleanup failures