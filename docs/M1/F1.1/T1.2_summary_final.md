# MVP-1 F1.1 T1.2 Summary - Arm PM with MCP Anchors

**Task:** T1.2 - Implement Arm PM (Protobuf + MCP Anchors)  
**Milestone:** MVP-1  
**Feature:** F1.1 - MCP Anchors  
**Commit:** Current branch sujinesh/M1_F1_T12  
**Status:** FAIL - Acceptance Criteria Not Met

## Acceptance Criteria Status

| Criterion | Target | Current | Status | Evidence |
|-----------|--------|---------|--------|----------|
| **Bytes/solve** | PM < C | PM: 1838.3, C: 902.6 | ❌ FAIL | PM is +103.7% higher |
| **Pass@1** | Within ±2pp of C | PM: 0%, C: 81.8% | ❌ FAIL | -81.8pp difference |
| **MCP deref p95** | < 50ms | Not measured | ❌ FAIL | MCP not triggered (outputs < 1KB) |
| **Hermetic runs** | Deterministic | EXECUTED | ✅ PASS | Both arms ran with seed 123 |
| **No synthetic content** | None in source | REMOVED | ✅ PASS | All synthetic generation removed |

## What Changed (Final Implementation)

### Critical Fixes Applied
1. **Removed ALL synthetic content from agents/**:
   - Deleted `_generate_realistic_test_output()` from `real_tester.py` (lines 218-336)
   - Replaced FileNotFoundError fallback with RuntimeError
   - Integrated RealTester into `pm_arm.py`

2. **Standardized dataset references**:
   - All configs now use `SWE-bench/SWE-bench_Lite`
   - Removed references to `princeton-nlp/SWE-bench_Lite`

3. **Set aggressive MCP threshold**:
   - `configs/generation.yaml`: `inline_max_bytes: 1024` (1KB)

### Files Modified
- `agents/real_tester.py` - Removed synthetic fallback, added hard error
- `agents/pm_arm.py` - Integrated RealTester for actual pytest execution
- `configs/generation.yaml` - Set MCP threshold to 1KB
- `configs/swebench_lite.yaml` - Updated to SWE-bench/SWE-bench_Lite
- `scripts/prepare_swebench.sh` - Updated dataset name
- `eval/swebench_bridge.py` - Updated dataset name

## Evidence Pack

### Hermetic Execution Results

```bash
# C Arm Execution
export HF_DATASETS_OFFLINE=1
export HERMES_HERMETIC=1
python3 -m eval.run_arms --arm C --dataset swebench_lite \
  --instances_file configs/swebench_lite_slice20.txt \
  --gen_cfg configs/generation.yaml --seed 123 --hermetic on

# Results:
Total tasks: 20
Passed: 16/20 (80.0%)
E2E latency p50: 3 ms
E2E latency p95: 5 ms
```

```bash
# PM Arm Execution  
export HF_DATASETS_OFFLINE=1
export HERMES_HERMETIC=1
python3 -m eval.run_arms --arm PM --dataset swebench_lite \
  --instances_file configs/swebench_lite_slice20.txt \
  --gen_cfg configs/generation.yaml --seed 123 --hermetic on

# Results:
Total tasks: 20
Passed: 0/20 (0.0%)
E2E latency p50: 3 ms
E2E latency p95: 4 ms
```

### Metrics Comparison

```json
{
  "c_arm": {
    "total_bytes": 19857,
    "avg_bytes_per_solve": 902.6,
    "pass_at_1": 0.818,
    "tasks_evaluated": 22
  },
  "pm_arm": {
    "total_bytes": 113973,
    "avg_bytes_per_solve": 1838.3,
    "pass_at_1": 0.0,
    "tasks_evaluated": 62
  },
  "comparison": {
    "bytes_increase_pct": 103.7,
    "pass_at_1_delta_pp": -81.8
  }
}
```

### Dataset Verification

```python
# Successfully loaded SWE-bench/SWE-bench_Lite
Dev split: 23 instances ✓
Test split: 300 instances ✓
Dataset saved to data/swebench_lite/main
```

### CI Guard Verification

```bash
$ make check-toy
Checking for banned toy/smoke patterns in source code...
✅ No banned patterns found in source code
```

## Root Cause Analysis

The PM arm failure is due to:

1. **Protobuf Schema Mismatch**: The `baseline_pb2.TestRequest` doesn't have all fields that RealTester expects (`repo`, `test_patch`, `patch`)

2. **Fixed Output Size**: PM arm produces consistent 860 bytes output for all tasks, suggesting the test runner is erroring consistently

3. **Error Messages**: "Error handling request: repo" indicates missing protobuf fields

## Next Steps to Fix

1. **Update protobuf schema** to include all required fields:
   ```proto
   message TestRequest {
     string task_id = 1;
     string repo = 2;
     string base_commit = 3;
     string test_patch = 4;
     string patch = 5;
     string test_name = 6;
   }
   ```

2. **Debug PM agent** test execution:
   - Add logging to see actual request structure
   - Verify RealTester receives correct instance data
   - Check if pytest is actually being invoked

3. **Verify MCP anchoring**:
   - Current outputs (860 bytes) are below 1KB threshold
   - Need actual pytest output (typically >32KB) to trigger anchoring

## Conclusion

While significant progress was made in removing synthetic content and executing hermetic evaluations, the acceptance criteria are NOT MET:

- ❌ PM arm produces MORE bytes than C arm (103.7% increase instead of reduction)
- ❌ PM arm has 0% pass rate (vs 81.8% for C arm)
- ❌ MCP anchoring not triggered (outputs too small)

The infrastructure is now correct (no synthetic content, hermetic execution working), but the PM agent implementation needs debugging to properly integrate with RealTester and achieve the expected bytes reduction through MCP anchoring.