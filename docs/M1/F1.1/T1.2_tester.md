# T1.2 - RealTester Implementation

## Overview

The RealTester agent implements strict MCP dereference, robust git patch application, and pytest execution with log anchoring for the HERMES system.

## Why

Previous test agents lacked:
- Strict validation of MCP references (could silently fail)
- Robust patch application with fallback strategies
- Efficient log handling for large test outputs
- Integration with PM anchoring for byte savings

## How It Works

### 1. Patch Loading (_load_patch_bytes)

Handles three input types:
- **bytes**: Returned as-is
- **mcp:// reference**: Strictly resolved via MCP client, raises ValueError if missing/empty
- **string**: Encoded to UTF-8 bytes

```python
def _load_patch_bytes(patch_or_ref):
    if isinstance(patch_or_ref, bytes):
        return patch_or_ref
    if patch_or_ref.startswith("mcp://"):
        data = mcp_client.resolve_bytes(patch_or_ref)
        if not data:
            raise ValueError(f"MCP reference {patch_or_ref} is missing or empty")
        return data
    return patch_or_ref.encode("utf-8")
```

### 2. Git Apply Sequence (apply_patch)

Tries multiple strategies in order:
1. `git apply --3way -p0` (three-way merge, strip 0 paths)
2. `git apply --3way -p1` (three-way merge, strip 1 path)
3. `git apply --3way -p2` (three-way merge, strip 2 paths)
4. `git apply -p0` (regular apply, strip 0 paths)
5. `git apply -p1` (regular apply, strip 1 path)
6. `git apply -p2` (regular apply, strip 2 paths)

The patch is written to `.hermes.patch` in the repository directory.

**Git Apply Flags Explained**:
- `--3way`: Attempts three-way merge if patch doesn't apply cleanly
- `-p<n>`: Strip n leading path components from filenames
- Order matters: three-way is more robust, try different strip levels for path variations

### 3. Pytest Execution and Log Anchoring

Runs pytest with:
- `-q` flag for quiet mode (less verbose output)
- `capture_output=True, text=False` to capture raw bytes
- 5-minute timeout for safety

Logs are anchored if > 1KB using PM manager:
- Threshold: 1024 bytes
- TTL: 24 hours (default for logs)
- Returns either raw bytes (inline) or `mcp://logs/<hash>` reference

## Strict Deref Policy

MCP references **must** resolve successfully:
- Empty or missing references raise `ValueError`
- No silent failures or fallbacks
- Ensures data integrity in the pipeline

## Tests

Located in `tests/agents/test_real_tester.py`:

1. **test_load_patch_bytes_inline_ref_strict**: Verifies strict MCP resolution
2. **test_apply_patch_sequence**: Tests git apply fallback strategies
3. **test_pytest_log_anchoring_small_vs_large**: Validates 1KB threshold for anchoring

## PM Metrics Tracked

- `anchors_created`: Number of new anchors created
- `bytes_saved`: Total bytes saved by anchoring vs inline
- `inline_count`: Number of payloads kept inline
- `anchor_count`: Total anchored payloads

## References

- [Git Apply Documentation](https://git-scm.com/docs/git-apply)
- [Pytest Quiet Mode](https://docs.pytest.org/en/stable/reference/reference.html#command-line-flags)