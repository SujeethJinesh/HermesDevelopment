# T1.2 - Transport Metrics Implementation

## Overview

Enhanced gRPC transport with comprehensive metrics tracking for bytes accounting, message path latency, and MCP dereference performance.

## Metrics Collected

### 1. Bytes Accounting
- **bytes_in**: Size of incoming protobuf messages (serialized)
- **bytes_out**: Size of outgoing protobuf messages (serialized)
- Tracked per message and aggregated

### 2. Message Path Timing
- **message_path_ms**: End-to-end processing time within service handler
- Measured using `time.perf_counter_ns()` for high precision
- Calculated as: `(end_ns - start_ns) / 1e6`

### 3. MCP Deref Timing
- **mcp_deref_ms**: Time to resolve MCP references
- Tracked in `MCPClient.resolve()` method
- Maintains rolling window of last 1000 measurements

## Implementation Details

### TransportMetrics Class

```python
class TransportMetrics:
    def record_bytes_out(size: int)
    def record_bytes_in(size: int)
    def record_message_path(duration_ms: float)
    def get_percentile(data: list, percentile: float) -> float
    def get_stats() -> Dict
```

Memory-efficient with 1000-measurement rolling window.

### Percentile Calculation

```python
def get_percentile(data, percentile):
    sorted_data = sorted(data)
    idx = int(len(sorted_data) * percentile)
    return sorted_data[min(idx, len(sorted_data) - 1)]
```

Provides p50, p95, p99 for latency analysis.

### Wire Bytes Measurement

Uses Protobuf `SerializeToString()` for accurate wire format size:
```python
bytes_in = len(request.SerializeToString())
bytes_out = len(result.SerializeToString())
```

## Metrics Output Format

### In metrics.jsonl:
```json
{
  "task_id": "django__django-11001",
  "bytes_in": 1234,
  "bytes_out": 5678,
  "message_path_ms": 12.5,
  "mcp_deref_ms_p95": 8.3,
  "timestamp": "2024-01-15T12:34:56"
}
```

### Aggregated Statistics:
```python
{
  "bytes_out_total": 123456,
  "bytes_in_total": 45678,
  "messages_sent": 100,
  "messages_received": 100,
  "message_path_ms_p50": 10.5,
  "message_path_ms_p95": 18.2,
  "message_path_ms_p99": 22.1
}
```

## Performance Targets

- **Message path p95**: < 20ms (local UNIX socket)
- **MCP deref p95**: < 50ms (local NVMe)
- **Bytes reduction**: PM < C (via anchoring)

## Integration with eval/run_arms.py

The metrics are:
1. Collected during agent execution
2. Written to `runs/{arm}/metrics.jsonl`
3. Aggregated into `summary.parquet`
4. Reported as p50/p95 per arm

## References

- [Protobuf Python Serialization](https://protobuf.dev/reference/python/python-generated/#fields)
- [Python time.perf_counter_ns()](https://docs.python.org/3/library/time.html#time.perf_counter_ns)