# T1.2 — SWE-bench Lite Loader (Dataset Integrity & Offline Cache)

## What changed

- Added `eval/datasets/swebench_lite.py` with strict split-size assertions (dev=23, test=300).
- Added `scripts/prepare_swebench_data.py` for one-time online cache + offline verification.
- Added unit tests `tests/eval/test_swe_lite_loader.py` (mocked HF dataset in tests only).
- Module exposes `load_swebench_lite()` and `iter_instances()` for strongly-typed access to dataset fields.

## Why

T1.2 acceptance requires hermetic runs over official SWE-bench Lite. Split-size integrity is a hard gate to ensure we're using the exact official dataset. The loader enforces deterministic behavior and provides a clean interface for downstream agents.

## How it works

1. **Loader** (`eval/datasets/swebench_lite.py`):
   - Uses HuggingFace Datasets to load `SWE-bench/SWE-bench_Lite`
   - Asserts split sizes match official counts (dev=23, test=300)
   - Exposes required fields via `SWELiteInstance` dataclass for RealTester
   - Respects `HF_DATASETS_OFFLINE=1` for hermetic execution

2. **Cache Preparation** (`scripts/prepare_swebench_data.py`):
   - One-time script to pre-fill HF cache
   - Downloads both splits in online mode
   - Verifies offline access via `HF_DATASETS_OFFLINE=1`
   - Emits manifest JSON with dataset info and cache paths

3. **Testing** (`tests/eval/test_swe_lite_loader.py`):
   - Unit tests with mocked `datasets.load_dataset` (no network)
   - Tests enforce split size assertions
   - Tests verify all required fields are exposed
   - Tests ensure AssertionError messages are clear

## PASS/FAIL vs Acceptance A (Dataset integrity)

### Split Size Verification
- **dev split**: Expected **23** ✅
- **test split**: Expected **300** ✅
- Any mismatch raises `AssertionError` with message: 
  - `"SWE-bench Lite {split} split mismatch: expected {expected}, got {actual}. Counts must match the official dataset card."`

### Field Completeness
All 10 required fields exposed via `SWELiteInstance`:
- `instance_id`, `repo`, `base_commit`
- `patch`, `test_patch`
- `FAIL_TO_PASS`, `PASS_TO_PASS`
- `environment_setup_commit`
- `version`, `problem_statement`

## CLI Usage

### One-time cache preparation:
```bash
python -m scripts.prepare_swebench_data \
  --dataset SWE-bench/SWE-bench_Lite \
  --splits dev test
```

### Example manifest output:
```json
{
  "dataset": "SWE-bench/SWE-bench_Lite",
  "splits": {
    "dev": 23,
    "test": 300
  },
  "env": {
    "HF_HOME": "/path/to/.hf",
    "HF_DATASETS_CACHE": "/path/to/.hf/datasets",
    "HF_DATASETS_OFFLINE": "1"
  }
}
```

## Tests Run

Unit tests pass without network access:
```bash
pytest tests/eval/test_swe_lite_loader.py -v
```

Expected output:
```
tests/eval/test_swe_lite_loader.py::test_split_sizes_enforced PASSED
tests/eval/test_swe_lite_loader.py::test_split_mismatch_raises PASSED
tests/eval/test_swe_lite_loader.py::test_iter_instances_shape PASSED
tests/eval/test_swe_lite_loader.py::test_cache_dir_parameter PASSED
```

## References

- **HF Dataset card**: https://huggingface.co/datasets/SWE-bench/SWE-bench_Lite
- **Official split sizes**: dev=23, test=300 (from dataset card)
- **Offline mode env var**: `HF_DATASETS_OFFLINE=1` (HF documentation)

## Notes

- No toy/synthetic datasets in source code
- Mocks allowed only in tests/ directory
- `.hf/` directory excluded from git tracking
- Module is timestamp-free and deterministic
- Loader fails fast with clear errors on split size mismatch