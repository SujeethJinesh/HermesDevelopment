# T1.2 Acceptance Checklist

**Branch:** sujinesh/M1_F1_T12  
**PR:** #6  
**Date:** 2025-08-28

## Pre-Acceptance Checklist

### ✅ Tracked Artifacts Removed
- [x] `runs/` files removed from PR (showing as deletions in diff)
- [x] `.gitignore` includes: `runs/`, `data/`, `.hf/`, `.mirrors/`, `scratch/`
- [x] CI guard in place: `.github/workflows/ban_artifacts.yml`

### ✅ Dataset Loader Faithful
- [x] Pinned to `SWE-bench/SWE-bench_Lite@main`
- [x] Hard asserts: `len(dev)==23` and `len(test)==300`
- [x] AssertionError on mismatch (lines 107-111 in `eval/datasets/swebench_lite.py`)

### ✅ Kind-Specific Anchoring Implemented
**File:** `agents/pm_arm.py` (lines 43-80)
- [x] Hard cap: 256KB (always anchor above)
- [x] Patches: 4096 bytes threshold (keep inline unless >4KB)
- [x] Logs/diffs: 1024 bytes threshold (anchor sooner)
- [x] Benefit-aware: only anchor if `len(ref) < len(data)`

### ✅ Unified Patch Loading
**File:** `agents/real_tester.py` (lines 151-216)
- [x] `_load_patch_bytes()` resolves MCP refs to bytes
- [x] Strip level fallback: tries p0, p1, p2 sequentially
- [x] MCP client returns strict bytes via `resolve_bytes()`

### ✅ Wire Byte Accounting
**File:** `transport/grpc_impl.py`
- [x] Measures full protobuf envelope: `len(envelope.SerializeToString())`
- [x] Both directions: `bytes_in` and `bytes_out`
- [x] Eval counts ref string when anchored, not original blob

## Owner Actions Required (Cannot be done from PR)

### 1. Prepare Repo Mirrors (One-time, ONLINE)
```bash
python scripts/prepare_swebench_repos.py \
  --instances_file configs/swebench_lite_slice20.txt
```

### 2. Pre-cache Dataset (One-time, ONLINE)
```bash
python scripts/prepare_swebench_data.py \
  --dataset SWE-bench/SWE-bench_Lite \
  --splits dev test
```
Verify: dev=23, test=300 rows

### 3. Run Hermetic Evaluation (OFFLINE)
```bash
export HERMES_HERMETIC=1
export HF_DATASETS_OFFLINE=1
export HF_HOME=$PWD/.hf
export HF_DATASETS_CACHE=$HF_HOME/datasets

# C arm baseline
python -m eval.run_arms --arm C --seed 12345 \
  --dataset swebench_lite \
  --instances_file configs/swebench_lite_slice20.txt \
  --gen_cfg configs/generation.yaml --hermetic on

# PM arm with MCP
python -m eval.run_arms --arm PM --seed 12345 \
  --dataset swebench_lite \
  --instances_file configs/swebench_lite_slice20.txt \
  --gen_cfg configs/generation.yaml --hermetic on
```

### 4. Final Artifact Sweep
```bash
git rm -r --cached runs data .hf .mirrors scratch || true
echo -e "runs/\ndata/\n.hf/\n.mirrors/\nscratch/\n" >> .gitignore
git add .gitignore
git commit -m "chore: purge tracked artifacts and hard-ignore"
```

## Acceptance Criteria

### Must Pass All:
- [ ] **PM < C bytes/solve** (anchored logs/diffs reduce bytes)
- [ ] **Pass@1 within ±2pp** of baseline C
- [ ] **MCP deref p95 < 50ms** (local NVMe)
- [ ] **No tracked artifacts** in final PR

## Evidence Required

### From Hermetic Runs:
1. **Metrics comparison table:**
   ```
   Metric          | C Arm  | PM Arm | Delta
   ----------------|--------|--------|-------
   bytes/solve     | X      | Y      | Y-X (<0)
   Pass@1          | A%     | B%     | |B-A|≤2
   E2E p50 (ms)    | ...    | ...    | ...
   E2E p95 (ms)    | ...    | ...    | ...
   MCP deref p95   | N/A    | <50ms  | ✓
   ```

2. **Run manifests** (not tracked, attach as artifacts):
   - `runs/C/summary.parquet`
   - `runs/PM/summary.parquet`
   - `runs/PM/metrics.jsonl`

3. **Deterministic proof:**
   - Same seed (12345) for both arms
   - Config hash matches

## Implementation Files

### Core Changes:
1. `agents/pm_arm.py` - Kind-specific anchoring with benefit analysis
2. `agents/real_tester.py` - Robust patch application with MCP resolution
3. `eval/datasets/swebench_lite.py` - Dataset pinning with assertions
4. `transport/grpc_impl.py` - Wire byte accounting
5. `mcp/client.py` - Strict bytes resolution

### Supporting Files:
- `configs/swebench_lite_slice20.txt` - 20 instance IDs
- `scripts/prepare_swebench_repos.py` - Mirror preparation
- `scripts/check_t12_acceptance.py` - Automated verification
- `.github/workflows/ban_artifacts.yml` - CI guard

## Status: PENDING OWNER ACTIONS

The implementation is **technically correct** and all code changes are in place:
- ✅ Benefit-aware anchoring that never makes bytes worse
- ✅ Kind-specific thresholds (patches >4KB, logs >1KB)  
- ✅ Robust patch application with strip levels
- ✅ Dataset pinned with hard assertions
- ✅ Wire byte accounting fixed

**Blocker:** Git mirrors must be prepared for real pytest execution to demonstrate byte reduction on large test logs.

## Commit Message Template

When ready to squash and merge:

```
fix(T1.2): Complete MCP anchoring with benefit-aware thresholds

Implements production-ready MCP anchoring for Arm PM with strict byte reduction guarantees:

- Kind-specific thresholds: patches >4KB, logs/diffs >1KB (agents/pm_arm.py)
- Benefit-aware: only anchor when len(ref) < len(data)
- Robust patch application with p0/p1/p2 fallback (agents/real_tester.py)
- Dataset pinned to SWE-bench/SWE-bench_Lite@main with assertions
- Wire byte accounting via protobuf envelope size

Acceptance evidence (pending hermetic runs):
- PM < C bytes/solve via anchored logs
- Pass@1 within ±2pp
- MCP deref p95 < 50ms

Fixes #6
```