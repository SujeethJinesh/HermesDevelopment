# T1.2 - Hermetic Scripts and CI Guards

## Overview

Scripts and CI workflows to ensure hermetic execution, prevent artifact contamination, and validate T1.2 acceptance criteria.

## Components

### 1. prepare_swebench_repos.py

Prepares SWE-bench repositories for hermetic execution in two phases:

**Phase 1 (Online)**: Fetch bare git mirrors
```bash
python scripts/prepare_swebench_repos.py \
    --instances-file configs/swebench_lite_slice20.txt \
    --mirrors-dir data/repos/mirrors \
    --online
```

**Phase 2 (Offline)**: Create shallow worktrees
```bash
python scripts/prepare_swebench_repos.py \
    --instances-file configs/swebench_lite_slice20.txt \
    --worktrees-dir scratch \
    --offline
```

**Implementation**:
- Parses instance IDs (e.g., `django__django-11001`)
- Creates bare mirrors in `data/repos/mirrors/`
- Creates detached worktrees in `scratch/`
- Writes `repos_manifest.json` for tracking

### 2. swebench_lite_slice20.txt

20 diverse test instances covering:
- **Django**: 10 instances (web framework)
- **Astropy**: 10 instances (astronomy library)

Selected for:
- Repository diversity
- Complexity variation
- Test coverage
- Reproducibility

### 3. check_t12_acceptance.py

Validates T1.2 acceptance criteria:

```bash
python scripts/check_t12_acceptance.py --runs-dir runs
```

**Checks**:
- **A**: Mean bytes/solve (PM < C)
- **B**: Pass@1 within ±2 percentage points
- **C**: Message path p95 < 20ms
- **D**: MCP deref p95 < 50ms
- **E**: Reproducibility with same seed

**Output**:
```
T1.2 Acceptance Criteria Check
==============================================================
A. Checking bytes/solve (PM < C)...
✓ PM uses 42.3% fewer bytes than C

B. Checking pass@1 (within ±2pp)...
✓ Pass@1 difference 1.2pp within ±2pp tolerance

C. Checking message path p95 (<20ms)...
✓ Message path p95 15.3ms < 20ms threshold

D. Checking MCP deref p95 (<50ms)...
✓ MCP deref p95 23.1ms < 50ms threshold

E. Checking reproducibility...
✓ C runs are reproducible (identical metrics)
✓ PM runs are reproducible (identical metrics)

==============================================================
SUMMARY
==============================================================
bytes_per_solve     : ✓ PASS
pass_at_1          : ✓ PASS
message_path_p95   : ✓ PASS
mcp_deref_p95      : ✓ PASS
reproducibility_c  : ✓ PASS
reproducibility_pm : ✓ PASS
------------------------------------------------------------
Overall: 6/6 checks passed
✓ T1.2 ACCEPTANCE CRITERIA MET
```

Exit code: 0 on success, 1 on failure.

### 4. ban_artifacts.yml

GitHub Actions workflow to prevent artifact contamination:

**Banned Directories**:
- `runs/**` - Evaluation outputs
- `data/**` - Datasets and repos
- `.hf/**` - Model cache
- `.mirrors/**` - Git mirrors
- `scratch/**` - Temporary files

**Checks**:
1. Scans changed files for banned patterns
2. Warns about toy/smoke/synthetic keywords
3. Verifies .gitignore configuration

**Enforcement**:
- Fails PR if banned artifacts detected
- Provides clear error messages
- Suggests remediation steps

## Hermetic Execution Guarantees

1. **Offline Operation**: All data pre-cached
2. **Deterministic Seeds**: Reproducible results
3. **Clean Scratch**: Isolated worktrees
4. **No Network**: Blocked during evaluation
5. **Artifact Isolation**: CI prevents contamination

## Usage in CI/CD

```yaml
# In PR workflow
- name: Run T1.2 Acceptance
  run: |
    # Prepare repos (offline)
    python scripts/prepare_swebench_repos.py \
      --instances-file configs/swebench_lite_slice20.txt \
      --offline
    
    # Run arms
    python -m eval.run_arms --arm C --hermetic on
    python -m eval.run_arms --arm PM --hermetic on
    
    # Check acceptance
    python scripts/check_t12_acceptance.py
```

## Security Considerations

- Git mirrors are read-only
- Worktrees are detached (no branch switching)
- Scratch is ephemeral (cleaned after runs)
- CI blocks artifact commits
- Network blocked during hermetic runs